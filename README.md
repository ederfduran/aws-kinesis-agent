# aws-kinesis-agent

This repo is intended to show how to interact/use Kinesis Agent in order to feed a Kinesis data stream and also do some light ETL transformation before to send the message.

## Requirements

In order to execute the example you need to have:

- aws cli
- your aws cli account configured (aws config and credentials)

## What is it doing?

We are creating a Server that will run the code we have in `/log-generator/LogGenerator.py`. this code will generate log files using `/log-generator/OnlineRetail.csv` as input. Then the kinesis Agent will take these files, apply a csv to json transformation and then will feed a Kinesis Data stream with these json files. Is important to notice that in `/log-generator/agent.json` we specify what Kinesis Data stream to feed and also the transformation we want to apply.

## Usage

You just need to run

```sh
./deploy
```

This shell script will perform the following actions:

1. Check if S3 artifacts bucket exist, if not it will create it. Artifacts bucket is a s3 bucket we use in order to save the code we want to execute on the server.
2. Once the Bucket is created we proceed to zip our code contents in put the zip file in our Artifacts Bucket.
3. Check for the default vpc in our aws account.
4. Create the stack using Cloudformation.

## Cloudformation

In case you are not familiar with cloud formation, this is a tool used to define Infrastructure as code, basically in this yaml file we are defining the resources we want to create in AWS.

The most important part to have in mind here is that we are creating a server using EC2, also in the user data we are telling the server to download the artifacts, install the kinesis agent and put it to run.

**Note: Update `KeyName` property under LogGenearatorServer to use your own .pem file in case you want to ssh into it later on**

## Validate server is working.....

- ssh into your server.

```sh
ssh -i <your.pem> ec2-user@<yourserver>.compute-1.amazonaws.com
```

- verify the agent is running.

```sh
sudo service aws-kinesis-agent status
```

- In case it is not running just execute the following command.

```sh
sudo service aws-kinesis-agent start
```

- Check the logs are being generated by your python code

```sh
cd /var/log/amazonlog/ && ls
```

- If you want to stop the agent just run

```sh
sudo service aws-kinesis-agent stop
```

## Validate the data is in your Data Stream

```sh
aws kinesis describe-stream --stream-name kinesis-logs-demo
aws kinesis get-shard-iterator --shard-id shardId-000000000000 --shard-iterator-type TRIM_HORIZON --stream-name  kinesis-logs-demo
aws kinesis get-records --shard-iterator <your iterator>
```
